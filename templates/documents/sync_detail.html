{% extends 'base.html' %}
{% load static %}

{% block title %}DÃ©tails de la Synchronisation{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“Š DÃ©tails de la Synchronisation</h1>
            <p class="text-gray-600">{{ log.timestamp|date:"d/m/Y Ã  H:i:s" }}</p>
            <p class="text-sm text-gray-500 mt-1">Par <strong>{{ log.user.first_name }} {{ log.user.last_name }}</strong></p>
        </div>
        <a href="{% url 'documents:sync_history' %}" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            â† Retour Ã  l'historique
        </a>
    </div>

    <!-- Backup Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-2 {% if log.backup_created %}border-green-200{% else %}border-yellow-200{% endif %}">
        <div class="flex items-center mb-4">
            <span class="text-3xl mr-3">{% if log.backup_created %}âœ…{% else %}âš ï¸{% endif %}</span>
            <h2 class="text-2xl font-bold {% if log.backup_created %}text-green-800{% else %}text-yellow-800{% endif %}">
                {% if log.backup_created %}Backup RÃ©ussi{% else %}Backup Ã‰chouÃ©{% endif %}
            </h2>
        </div>
        <div class="space-y-2">
            <p class="text-gray-700"><strong>Message:</strong> {{ log.backup_message }}</p>
            {% if log.backup_path %}
            <p class="text-gray-700"><strong>Chemin:</strong> <code class="bg-gray-100 px-2 py-1 rounded text-sm">{{ log.backup_path }}</code></p>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Reference Data -->
        <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg shadow-md p-6 border-2 border-purple-200">
            <h3 class="text-xl font-bold text-purple-800 mb-4">ğŸ“š DonnÃ©es de RÃ©fÃ©rence</h3>
            <div class="space-y-3">
                <!-- Subjects -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-purple-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ“–</span>
                        <div>
                            <p class="font-semibold text-gray-800">MatiÃ¨res</p>
                            <p class="text-sm text-gray-600">Sujets d'enseignement</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.subjects_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.subjects_updated }}</div>
                    </div>
                </div>

                <!-- Levels -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-purple-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ“</span>
                        <div>
                            <p class="font-semibold text-gray-800">Niveaux</p>
                            <p class="text-sm text-gray-600">Classes et niveaux</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.levels_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.levels_updated }}</div>
                    </div>
                </div>

                <!-- Tariffs -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-purple-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ·ï¸</span>
                        <div>
                            <p class="font-semibold text-gray-800">Tarifs</p>
                            <p class="text-sm text-gray-600">Prix et forfaits</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.tariffs_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.tariffs_updated }}</div>
                    </div>
                </div>

                <!-- Discounts -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-purple-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ«</span>
                        <div>
                            <p class="font-semibold text-gray-800">RÃ©ductions</p>
                            <p class="text-sm text-gray-600">Codes promotionnels</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.discounts_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.discounts_updated }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Data -->
        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-lg shadow-md p-6 border-2 border-emerald-200">
            <h3 class="text-xl font-bold text-emerald-800 mb-4">ğŸ‘¥ DonnÃ©es Principales</h3>
            <div class="space-y-3">
                <!-- Students -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-emerald-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ‘¤</span>
                        <div>
                            <p class="font-semibold text-gray-800">Ã‰tudiants</p>
                            <p class="text-sm text-gray-600">Profils et inscriptions</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.students_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.students_updated }}</div>
                    </div>
                </div>

                <!-- Cohorts -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-emerald-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ“š</span>
                        <div>
                            <p class="font-semibold text-gray-800">Cohorts</p>
                            <p class="text-sm text-gray-600">Groupes et formations</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.cohorts_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.cohorts_updated }}</div>
                    </div>
                </div>

                <!-- Sessions -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-emerald-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ“…</span>
                        <div>
                            <p class="font-semibold text-gray-800">Sessions</p>
                            <p class="text-sm text-gray-600">SÃ©ances de formation</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.sessions_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.sessions_updated }}</div>
                        {% if log.stats_json.sessions_deleted %}
                        <div class="text-sm text-red-600">ğŸ—‘ï¸ {{ log.stats_json.sessions_deleted }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Enrollments -->
                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-emerald-100">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">ğŸ“‹</span>
                        <div>
                            <p class="font-semibold text-gray-800">Inscriptions</p>
                            <p class="text-sm text-gray-600">Contrats d'Ã©tudes</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">+{{ log.stats_json.enrollments_added }}</div>
                        <div class="text-sm text-blue-600">â†» {{ log.stats_json.enrollments_updated }}</div>
                        {% if log.stats_json.enrollments_deleted %}
                        <div class="text-sm text-red-600">ğŸ—‘ï¸ {{ log.stats_json.enrollments_deleted }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Operations Data -->
    <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-lg shadow-md p-6 border-2 border-orange-200 mb-6">
        <h3 class="text-xl font-bold text-orange-800 mb-4">ğŸ’° DonnÃ©es OpÃ©rationnelles</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Presences -->
            <div class="bg-white rounded-lg p-4 border border-orange-100">
                <p class="font-semibold text-gray-800 mb-2">âœ… PrÃ©sences</p>
                <div class="space-y-1">
                    <div class="text-lg font-bold text-green-600">+{{ log.stats_json.presences_added }}</div>
                    <div class="text-sm text-blue-600">â†» {{ log.stats_json.presences_updated }}</div>
                </div>
            </div>

            <!-- Student Payments -->
            <div class="bg-white rounded-lg p-4 border border-orange-100">
                <p class="font-semibold text-gray-800 mb-2">ğŸ’° Paiements Ã‰tudiants</p>
                <div class="space-y-1">
                    <div class="text-lg font-bold text-green-600">+{{ log.stats_json.paiements_etudiants_added }}</div>
                    <div class="text-sm text-blue-600">â†» {{ log.stats_json.paiements_etudiants_updated }}</div>
                </div>
            </div>

            <!-- Teacher Payments -->
            <div class="bg-white rounded-lg p-4 border border-orange-100">
                <p class="font-semibold text-gray-800 mb-2">ğŸ’µ Paiements Profs</p>
                <div class="space-y-1">
                    <div class="text-lg font-bold text-green-600">+{{ log.stats_json.paiements_profs_added }}</div>
                    <div class="text-sm text-blue-600">â†» {{ log.stats_json.paiements_profs_updated }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border-2 border-green-200">
            <p class="text-gray-600 text-sm font-semibold">âœ¨ AjoutÃ©s</p>
            <p class="text-3xl font-bold text-green-600">{{ log.stats_json.students_added|add:log.stats_json.cohorts_added|add:log.stats_json.sessions_added|add:log.stats_json.enrollments_added|add:log.stats_json.presences_added }}</p>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-200">
            <p class="text-gray-600 text-sm font-semibold">ğŸ”„ Mis Ã  jour</p>
            <p class="text-3xl font-bold text-blue-600">{{ log.stats_json.students_updated|add:log.stats_json.cohorts_updated|add:log.stats_json.sessions_updated|add:log.stats_json.enrollments_updated|add:log.stats_json.presences_updated }}</p>
        </div>
        <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-lg p-4 border-2 border-red-200">
            <p class="text-gray-600 text-sm font-semibold">ğŸ—‘ï¸ SupprimÃ©s</p>
            <p class="text-3xl font-bold text-red-600">{{ log.stats_json.sessions_deleted|add:log.stats_json.enrollments_deleted }}</p>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border-2 border-purple-200">
            <p class="text-gray-600 text-sm font-semibold">ğŸ“Š Total</p>
            <p class="text-3xl font-bold text-purple-600">{{ log.total_items_processed }}</p>
        </div>
    </div>

    <!-- Errors Section -->
    {% if log.error_count > 0 %}
    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6">
        <div class="flex items-center mb-4">
            <span class="text-3xl mr-3">âš ï¸</span>
            <h3 class="text-xl font-bold text-red-800">{{ log.error_count }} Erreur(s) DÃ©tectÃ©e(s)</h3>
        </div>
        <div class="space-y-2 max-h-96 overflow-y-auto">
            {% for error in log.errors_json %}
            <div class="bg-white border-l-4 border-red-500 p-3 rounded">
                <p class="text-sm text-gray-700">{{ error }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
        <div class="flex items-center">
            <span class="text-3xl mr-3">âœ…</span>
            <p class="text-lg font-semibold text-green-800">Synchronisation complÃ©tÃ©e sans erreurs!</p>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}
