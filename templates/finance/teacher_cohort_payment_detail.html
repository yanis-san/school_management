{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}D√©tail Paie - {{ cohort.name }}{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white p-6 rounded-xl shadow-sm">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex-1">
                <h1 class="text-2xl font-bold">{{ cohort.name }}</h1>
                <p class="text-indigo-100 mt-1">
                    {{ teacher.get_full_name }} ‚Ä¢ {{ cohort.teacher_hourly_rate }} DA/h
                    {% if is_substitute %}
                    <span class="inline-block bg-orange-200 text-orange-900 text-xs font-medium px-2.5 py-0.5 rounded ml-2">
                        Rempla√ßant
                    </span>
                    {% endif %}
                </p>
                {% if is_substitute %}
                <p class="text-indigo-200 text-sm mt-1">Professeur Titulaire: {{ cohort.teacher.get_full_name }}</p>
                {% endif %}
            </div>
            <div class="text-right">
                <div class="text-xs uppercase text-indigo-200 font-medium">P√©riode S√©lectionn√©e</div>
                <div class="text-sm font-medium">{{ period_start|date:"d/m/Y" }} au {{ period_end|date:"d/m/Y" }}</div>
            </div>
        </div>
        
        {% if teachers_list|length > 1 %}
        <div class="mt-4 pt-4 border-t border-indigo-500">
            <label class="block text-sm text-indigo-100 mb-2">Changer de professeur:</label>
            <select onchange="window.location.href=this.value" class="px-4 py-2 rounded-lg bg-white text-gray-800 font-medium">
                {% for t in teachers_list %}
                <option value="?teacher={{ t.teacher.id }}{% if period_start %}&start={{ period_start|date:'Y-m-d' }}{% endif %}{% if period_end %}&end={{ period_end|date:'Y-m-d' }}{% endif %}"
                        {% if t.teacher.id == teacher.id %}selected{% endif %}>
                    {{ t.teacher.get_full_name }}{% if t.is_substitute %} (Rempla√ßant){% else %} (Titulaire){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    <!-- Filtre de p√©riode -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="font-bold text-gray-700 mb-4">üîç Filtrer par P√©riode</h3>
        <form method="get" class="flex flex-col sm:flex-row gap-4 items-end">
            <input type="hidden" name="teacher" value="{{ teacher.id }}">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Date D√©but</label>
                <input type="date" name="start" value="{{ period_start|date:'Y-m-d' }}"
                       min="{{ cohort_start_date|date:'Y-m-d' }}"
                       max="{{ cohort_end_date|date:'Y-m-d' }}"
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Date Fin</label>
                <input type="date" name="end" value="{{ period_end|date:'Y-m-d' }}"
                       min="{{ cohort_start_date|date:'Y-m-d' }}"
                       max="{{ cohort_end_date|date:'Y-m-d' }}"
                       class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
            </div>
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-2 rounded-lg transition whitespace-nowrap">
                Appliquer
            </button>
            <a href="?teacher={{ teacher.id }}&start={{ cohort_start_date|date:'Y-m-d' }}&end={{ cohort_end_date|date:'Y-m-d' }}"
               class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-6 py-2 rounded-lg transition whitespace-nowrap text-center">
                R√©initialiser
            </a>
        </form>
        <small class="text-gray-500 mt-3 block">Dates du cohort: {{ cohort_start_date|date:"d/m/Y" }} √† {{ cohort_end_date|date:"d/m/Y" }}</small>
    </div>

    <!-- R√©sum√© financier -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500 uppercase font-medium mb-1">S√©ances</div>
            <div class="text-3xl font-bold text-gray-800">{{ session_details|length }}</div>
            <div class="text-xs text-gray-400 mt-1">Compl√©t√©es</div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500 uppercase font-medium mb-1">Heures Totales</div>
            <div class="text-3xl font-bold text-gray-800">{{ total_hours }}h</div>
            <div class="text-xs text-gray-400 mt-1">Travaill√©es</div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500 uppercase font-medium mb-1">Montant D√ª</div>
            <div class="text-3xl font-bold text-indigo-600">{{ amount_due|floatformat:0 }} DA</div>
            <div class="text-xs text-gray-400 mt-1">√Ä calculer</div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="text-sm text-gray-500 uppercase font-medium mb-1">Reste √† Payer</div>
            <div class="text-3xl font-bold {% if balance_due > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                {{ balance_due|floatformat:0 }} DA
            </div>
            <div class="text-xs text-gray-400 mt-1">
                {% if balance_due <= 0 %}‚úì Sold√©{% else %}En attente{% endif %}
            </div>
        </div>
    </div>

    <!-- D√©tail des s√©ances -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h3 class="font-bold text-gray-700">D√©tail des S√©ances</h3>
        </div>

        {% if session_details %}
        <table class="w-full text-left">
            <thead class="bg-gray-50 border-b border-gray-100">
                <tr class="text-gray-500 text-xs uppercase">
                    <th class="px-6 py-3">Date</th>
                    <th class="px-6 py-3">Horaire</th>
                    <th class="px-6 py-3 text-right">Dur√©e</th>
                    <th class="px-6 py-3 text-right">Tarif</th>
                    <th class="px-6 py-3 text-right">R√©mun√©ration</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for detail in session_details %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">
                        {{ detail.session.date|date:"l d/m/Y" }}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        {{ detail.session.display_start_time|time:"H:i" }} - {{ detail.session.display_end_time|time:"H:i" }}
                        {% if detail.session.duration_override_minutes %}
                        <span class="inline-block ml-2 px-2 py-0.5 bg-orange-100 text-orange-800 text-xs font-bold rounded">
                            ‚è±Ô∏è OVERRIDE
                        </span>
                        {% endif %}
                        {% if detail.session.is_ramadan %}
                        <span class="inline-block ml-2 px-2 py-0.5 bg-amber-100 text-amber-800 text-[11px] font-bold rounded">
                            Ramadan
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-medium {% if detail.session.duration_override_minutes %}text-orange-600{% else %}text-gray-700{% endif %}">
                        {{ detail.hours }}h
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-gray-600">
                        {{ detail.hourly_rate }} DA/h
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-bold text-indigo-600">
                        {{ detail.pay }} DA
                    </td>
                </tr>
                {% endfor %}
                <tr class="bg-indigo-50 font-bold">
                    <td colspan="4" class="px-6 py-4 text-sm text-gray-700">TOTAL</td>
                    <td class="px-6 py-4 text-right text-lg text-indigo-600">{{ amount_due|floatformat:0 }} DA</td>
                </tr>
            </tbody>
        </table>
        {% else %}
        <div class="p-12 text-center text-gray-400">
            <p>Aucune s√©ance compl√©t√©e pour cette p√©riode</p>
        </div>
        {% endif %}
    </div>

    <!-- Historique des paiements -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <h3 class="font-bold text-gray-700">Historique des Paiements</h3>
            {% if balance_due > 0 %}
            <a href="{% url 'finance:record_cohort_payment' cohort.id %}?teacher={{ teacher.id }}{% if period_start %}&start={{ period_start|date:'Y-m-d' }}{% endif %}{% if period_end %}&end={{ period_end|date:'Y-m-d' }}{% endif %}&amount={{ balance_due }}"
               class="text-green-600 hover:text-green-800 font-medium text-sm px-3 py-1 border border-green-200 hover:border-green-600 rounded transition">
                + Enregistrer un Paiement
            </a>
            {% endif %}
        </div>

        {% if payment_history %}
        <table class="w-full text-left">
            <thead class="bg-gray-50 border-b border-gray-100">
                <tr class="text-gray-500 text-xs uppercase">
                    <th class="px-6 py-3">Date</th>
                    <th class="px-6 py-3">Montant D√ª</th>
                    <th class="px-6 py-3">Montant Pay√©</th>
                    <th class="px-6 py-3">M√©thode</th>
                    <th class="px-6 py-3">Notes</th>
                    <th class="px-6 py-3">Par</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for payment in payment_history %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">
                        {{ payment.payment_date|date:"d/m/Y" }}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        {{ payment.amount_due|floatformat:0 }} DA
                    </td>
                    <td class="px-6 py-4 text-sm font-bold text-green-600">
                        {{ payment.amount_paid|floatformat:0 }} DA
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                            {% if payment.payment_method == 'CASH' %}bg-green-100 text-green-700
                            {% elif payment.payment_method == 'TRANSFER' %}bg-blue-100 text-blue-700
                            {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {% if payment.payment_method == 'CASH' %}üíµ Esp√®ces
                            {% elif payment.payment_method == 'TRANSFER' %}üè¶ Virement
                            {% else %}üìã Ch√®que{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        {{ payment.notes|default:"-" }}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        {{ payment.recorded_by.get_full_name }}
                    </td>
                </tr>
                {% endfor %}
                <tr class="bg-green-50 font-bold">
                    <td colspan="2" class="px-6 py-4 text-sm text-gray-700">TOTAL PAY√â</td>
                    <td class="px-6 py-4 text-lg text-green-600">{{ total_paid|floatformat:0 }} DA</td>
                    <td colspan="3"></td>
                </tr>
            </tbody>
        </table>
        {% else %}
        <div class="p-12 text-center text-gray-400">
            <p>Aucun paiement enregistr√©</p>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}
