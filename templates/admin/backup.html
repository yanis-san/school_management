{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Gestion des Sauvegardes - Admin{% endblock %}

{% block content %}
<div id="content-main">
    <h1>ğŸ’¾ Gestion des Sauvegardes de la Base de DonnÃ©es</h1>
    
    <div style="margin-top: 20px;">
        <!-- Section Infos -->
        <div style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h2>ğŸ“Š Informations</h2>
            <p><strong>ğŸ“ Dossier de sauvegarde:</strong> {{ backup_dir }}</p>
            <p><strong>ğŸ“¦ Nombre de sauvegardes:</strong> {{ total_backups }}</p>
        </div>

        <!-- Section Actions -->
        <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h2>âš¡ Actions</h2>
            <button id="btn-backup" style="
                padding: 10px 20px;
                background: #417690;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            ">ğŸ”„ CrÃ©er une Sauvegarde</button>
        </div>

        <!-- Section Sauvegardes existantes -->
        <div style="background: #fffbf0; padding: 15px; border-radius: 5px;">
            <h2>ğŸ“‹ Sauvegardes Existantes</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #417690; color: white;">
                        <th style="padding: 10px; text-align: left;">Fichier</th>
                        <th style="padding: 10px; text-align: left;">Taille</th>
                        <th style="padding: 10px; text-align: left;">Date</th>
                        <th style="padding: 10px; text-align: left;">IntÃ©gritÃ©</th>
                        <th style="padding: 10px; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="backup-list">
                    {% for backup in backup_list %}
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px;">{{ backup.name }}</td>
                        <td style="padding: 10px;">{{ backup.size_mb|floatformat:2 }} MB</td>
                        <td style="padding: 10px;">{{ backup.date }}</td>
                        <td style="padding: 10px;">âœ… {{ backup.hash }}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button class="btn-restore" data-backup="{{ backup.name }}" style="
                                padding: 5px 10px;
                                background: #28a745;
                                color: white;
                                border: none;
                                border-radius: 3px;
                                cursor: pointer;
                            ">ğŸ“¥ Restaurer</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="padding: 20px; text-align: center; color: #999;">
                            Aucune sauvegarde trouvÃ©e. CrÃ©ez la premiÃ¨re en cliquant sur le bouton ci-dessus.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.getElementById('btn-backup').addEventListener('click', function() {
    if (confirm('ğŸ”„ CrÃ©er une nouvelle sauvegarde?')) {
        fetch('{% url "admin:backup_create" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(e => alert('âŒ Erreur: ' + e));
    }
});

document.querySelectorAll('.btn-restore').forEach(btn => {
    btn.addEventListener('click', function() {
        const backup = this.dataset.backup;
        if (confirm('âš ï¸ ATTENTION: Ceci va REMPLACER la base de donnÃ©es actuelle. ÃŠtes-vous sÃ»r?\\n\\nSauvegarde: ' + backup)) {
            fetch('{% url "admin:backup_restore" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'backup_name=' + encodeURIComponent(backup)
            })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    setTimeout(() => location.reload(), 2000);
                }
            })
            .catch(e => alert('âŒ Erreur: ' + e));
        }
    });
});
</script>

<style>
    h1 {
        color: #417690;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }
    
    h2 {
        color: #417690;
        margin-top: 0;
    }
    
    table {
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
    }
</style>
{% endblock %}
