{% extends 'base.html' %}

{% block title %}D√©tail Campagne Email{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center gap-3">
        <a href="{% url 'emails:dashboard' %}" class="text-indigo-600 hover:text-indigo-900">‚Üê Retour</a>
        <h1 class="text-2xl font-bold text-gray-800">D√©tail de la Campagne</h1>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p class="text-sm text-gray-500 font-semibold">Titre</p>
                <p class="text-gray-800">{{ campaign.title }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 font-semibold">Date d'envoi</p>
                <p class="text-gray-800">{{ campaign.sent_at|date:"d/m/Y √† H:i" }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 font-semibold">Type de destinataires</p>
                <p class="text-gray-800">{{ campaign.get_recipient_type_display }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 font-semibold">Cohort</p>
                <p class="text-gray-800">{{ campaign.cohort.name|default:"-" }}</p>
            </div>
        </div>

        <hr class="border-gray-200">

        <div>
            <p class="text-sm text-gray-500 font-semibold mb-2">Objet</p>
            <p class="text-gray-800 font-medium">{{ campaign.subject }}</p>
        </div>

        <div>
            <p class="text-sm text-gray-500 font-semibold mb-2">Message</p>
            <div class="bg-gray-50 p-4 rounded border border-gray-200 whitespace-pre-wrap text-sm">{{ campaign.message }}</div>
        </div>

        {% if campaign.attachment %}
        <div>
            <p class="text-sm text-gray-500 font-semibold mb-2">Pi√®ce jointe</p>
            <a href="{{ campaign.attachment.url }}" class="text-indigo-600 hover:text-indigo-900 text-sm" target="_blank">üìé {{ campaign.attachment.name }}</a>
        </div>
        {% endif %}

        <hr class="border-gray-200">

        <div class="grid grid-cols-3 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <p class="text-sm text-blue-600 font-semibold">Total Destinataires</p>
                <p class="text-2xl font-bold text-blue-800">{{ campaign.total_recipients }}</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <p class="text-sm text-green-600 font-semibold">Envois R√©ussis</p>
                <p class="text-2xl font-bold text-green-800">{{ campaign.success_count }}</p>
            </div>
            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                <p class="text-sm text-red-600 font-semibold">Envois √âchou√©s</p>
                <p class="text-2xl font-bold text-red-800">{{ campaign.failure_count }}</p>
            </div>
        </div>

        <!-- Onglets pour succ√®s/√©checs -->
        <div class="mt-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button onclick="showTab('all')" id="tab-all" class="tab-button active border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Tous ({{ recipients_data|length }})
                    </button>
                    <button onclick="showTab('success')" id="tab-success" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        ‚úÖ R√©ussis ({{ success_recipients|length }})
                    </button>
                    <button onclick="showTab('failed')" id="tab-failed" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        ‚ùå √âchou√©s ({{ failed_recipients|length }})
                    </button>
                </nav>
            </div>

            <!-- Contenu des onglets -->
            <div id="content-all" class="tab-content mt-4">
                <div class="bg-gray-50 rounded-lg border border-gray-200 max-h-96 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Erreur</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for recipient in recipients_data %}
                            <tr class="{% if recipient.status == 'failed' %}bg-red-50{% endif %}">
                                <td class="px-4 py-3 text-sm text-gray-500">{{ forloop.counter }}</td>
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ recipient.email }}</td>
                                <td class="px-4 py-3 text-sm">
                                    {% if recipient.status == 'success' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            ‚úÖ R√©ussi
                                        </span>
                                    {% elif recipient.status == 'failed' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            ‚ùå √âchou√©
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            ? Inconnu
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ recipient.sent_at|default:"-" }}</td>
                                <td class="px-4 py-3 text-sm text-red-600">
                                    {% if recipient.error %}
                                        <span class="truncate max-w-xs inline-block" title="{{ recipient.error }}">{{ recipient.error }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="content-success" class="tab-content hidden mt-4">
                <div class="bg-green-50 rounded-lg border border-green-200 p-4 max-h-96 overflow-y-auto">
                    <div class="space-y-2">
                        {% for recipient in success_recipients %}
                        <div class="flex items-center justify-between bg-white px-4 py-2 rounded border border-green-100">
                            <div class="flex items-center gap-3">
                                <span class="text-green-600 text-lg">‚úÖ</span>
                                <span class="text-sm font-medium text-gray-900">{{ recipient.email }}</span>
                            </div>
                            <span class="text-xs text-gray-500">{{ recipient.sent_at }}</span>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-500 py-8">Aucun envoi r√©ussi</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div id="content-failed" class="tab-content hidden mt-4">
                <div class="bg-red-50 rounded-lg border border-red-200 p-4 max-h-96 overflow-y-auto">
                    <div class="space-y-2">
                        {% for recipient in failed_recipients %}
                        <div class="bg-white p-4 rounded border border-red-100">
                            <div class="flex items-start gap-3">
                                <span class="text-red-600 text-lg mt-1">‚ùå</span>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-900">{{ recipient.email }}</span>
                                        <span class="text-xs text-gray-500">{{ recipient.sent_at }}</span>
                                    </div>
                                    {% if recipient.error %}
                                    <div class="bg-red-50 border border-red-200 rounded p-2">
                                        <p class="text-xs text-red-700 font-mono">{{ recipient.error }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-center text-gray-500 py-8">Aucun √©chec d'envoi üéâ</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div>
            <p class="text-sm text-gray-500 font-semibold">Envoy√© par</p>
            <p class="text-gray-800">{{ campaign.sent_by.get_full_name }}</p>
        </div>
    </div>
</div>

<script>
function showTab(tab) {
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    
    // R√©initialiser tous les boutons
    document.querySelectorAll('.tab-button').forEach(el => {
        el.classList.remove('border-indigo-500', 'text-indigo-600');
        el.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Afficher le contenu s√©lectionn√©
    document.getElementById('content-' + tab).classList.remove('hidden');
    
    // Activer le bouton s√©lectionn√©
    const activeButton = document.getElementById('tab-' + tab);
    activeButton.classList.remove('border-transparent', 'text-gray-500');
    activeButton.classList.add('border-indigo-500', 'text-indigo-600');
}
</script>
{% endblock %}
