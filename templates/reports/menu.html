{% extends 'base.html' %}

{% block title %}Rapports et Documents PDF{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ tab: 'synthese' }">

    <!-- En-t√™te -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold">üìÑ Rapports et Documents PDF</h1>
        <p class="text-purple-100 mt-2">Choisissez une cat√©gorie ci-dessous pour g√©n√©rer vos rapports</p>
    </div>

    <!-- Onglets -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="flex flex-wrap gap-2 p-2 border-b border-gray-200">
            <button @click="tab='synthese'" :class="tab==='synthese' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'" class="px-4 py-2 rounded-lg font-medium shadow-sm">Synth√®se</button>
            <button @click="tab='caisse'" :class="tab==='caisse' ? 'bg-emerald-600 text-white' : 'bg-white text-gray-700'" class="px-4 py-2 rounded-lg font-medium shadow-sm">Caisse</button>
            <button @click="tab='annuels'" :class="tab==='annuels' ? 'bg-purple-600 text-white' : 'bg-white text-gray-700'" class="px-4 py-2 rounded-lg font-medium shadow-sm">Annuels</button>
            <button @click="tab='etudiants'" :class="tab==='etudiants' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'" class="px-4 py-2 rounded-lg font-medium shadow-sm">√âtudiants</button>
            <button @click="tab='seances'" :class="tab==='seances' ? 'bg-green-600 text-white' : 'bg-white text-gray-700'" class="px-4 py-2 rounded-lg font-medium shadow-sm">S√©ances</button>
            <button @click="tab='paiements'" :class="tab==='paiements' ? 'bg-yellow-600 text-white' : 'bg-white text-gray-700'" class="px-4 py-2 rounded-lg font-medium shadow-sm">Paiements</button>
        </div>

        <div class="p-4 md:p-6 space-y-6">
            <!-- Tab: Synth√®se -->
            <div x-show="tab==='synthese'" x-cloak class="space-y-6">
                <!-- Statistiques rapides -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-sm text-gray-500 uppercase font-medium">√âtudiants</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">{{ total_students }}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-sm text-gray-500 uppercase font-medium">Groupes</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">{{ total_cohorts }}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-sm text-gray-500 uppercase font-medium">S√©ances</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">{{ total_sessions }}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="text-sm text-gray-500 uppercase font-medium">Professeurs</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">{{ total_teachers }}</div>
                    </div>
                </div>

                <!-- ZIP Complet -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl shadow-lg overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            T√©l√©charger TOUS les Rapports (ZIP)
                        </h2>
                    </div>
                    <div class="p-6">
                        <form method="GET" action="{% url 'reports:all_zip' %}" class="space-y-4">
                            <div class="bg-white p-4 rounded-lg border border-green-200">
                                <p class="text-sm text-gray-700 mb-3 font-medium">
                                    G√©n√©rez un fichier ZIP contenant tous les rapports PDF pour une p√©riode donn√©e.
                                    Par d√©faut: <strong>Mois courant</strong>
                                </p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de d√©but</label>
                                        <input type="date" name="start" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Laissez vide pour mois courant">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Date de fin</label>
                                        <input type="date" name="end" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Laissez vide pour mois courant">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-3 rounded-lg font-bold text-lg transition shadow-lg flex items-center justify-center gap-3">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                G√©n√©rer le ZIP Complet
                            </button>
                            <p class="text-xs text-gray-600 text-center">üì¶ Contenu: Liste √©tudiants, √âtudiants par groupe, S√©ances, Paiements, Paie professeurs</p>
                        </form>
                    </div>
                </div>

                <!-- Astuces -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                    <p class="font-semibold mb-1">üí° Conseils d'utilisation</p>
                    <ul class="text-sm text-blue-800 list-disc list-inside space-y-1">
                        <li>Les PDF s'ouvrent dans un nouvel onglet</li>
                        <li>Tous les rapports incluent la date de g√©n√©ration</li>
                        <li>Les donn√©es sont √† jour au moment du clic</li>
                    </ul>
                </div>
            </div>

            <!-- Tab: Caisse -->
            <div x-show="tab==='caisse'" x-cloak class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border border-emerald-200">
                    <h3 class="font-semibold text-emerald-800 mb-1">Rapports Caisse</h3>
                    <p class="text-sm text-gray-700">Cat√©gories, transactions et synth√®se avec filtres de dates. Exports PDF/CSV.</p>
                </div>
                <div class="flex items-center justify-between p-4 bg-white rounded-lg border">
                    <div>
                        <h4 class="font-semibold text-gray-800">Ouvrir l'espace Caisse</h4>
                        <p class="text-sm text-gray-600">Onglets Alpine.js d√©di√©s aux rapports de caisse.</p>
                    </div>
                    <a href="{% url 'reports:cash_page' %}" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">Page Caisse</a>
                </div>
            </div>

            <!-- Tab: Annuels -->
            <div x-show="tab==='annuels'" x-cloak class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border border-purple-200">
                    <h3 class="font-semibold text-purple-800 mb-1">Rapports Annuels (Ann√©e Acad√©mique)</h3>
                    <p class="text-sm text-gray-700">PDF group√© mati√®re‚Üígroupe, CSV √† plat, et ZIP (un PDF par groupe). Inclut la colonne "Actif".</p>
                </div>
                <div class="flex items-center justify-between p-4 bg-white rounded-lg border">
                    <div>
                        <h4 class="font-semibold text-gray-800">S√©lection par ann√©e</h4>
                        <p class="text-sm text-gray-600">Filtrez par ann√©e (ou toutes) puis exportez.</p>
                    </div>
                    <a href="{% url 'reports:annual_menu' %}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">Ouvrir</a>
                </div>

                <div class="p-4 bg-white rounded-lg border">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-800">Frais d'inscription NON PAY√âS</h4>
                            <p class="text-sm text-gray-600">Liste des √©tudiants inscrits sur l'ann√©e active (ou s√©lectionn√©e) n'ayant pas r√©gl√© les frais annuels.</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="{% url 'reports:annual_fees_unpaid_pdf' %}" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">PDF (ann√©e active)</a>
                            <a href="{% url 'reports:annual_fees_unpaid_csv' %}" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">CSV</a>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Astuce: vous pouvez aussi passer des filtres GET (ex: ?year=2025&subject=3&cohort=12).</p>
                </div>
            </div>

            <!-- Tab: √âtudiants -->
            <div x-show="tab==='etudiants'" x-cloak class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border border-blue-200">
                    <h3 class="font-semibold text-blue-800 mb-1">Rapports √âtudiants</h3>
                    <p class="text-sm text-gray-700">Listes globales et par groupe. Utile pour pr√©sence et contact.</p>
                </div>
                <div class="flex items-center justify-between p-4 bg-white rounded-lg border">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">Liste compl√®te des √©tudiants</h4>
                        <p class="text-sm text-gray-600">Tous les √©tudiants actifs avec coordonn√©es et inscriptions.</p>
                    </div>
                    <a href="{% url 'reports:students_all' %}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">G√©n√©rer PDF</a>
                </div>
                <div class="p-4 bg-white rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">√âtudiants par groupe</h4>
                    <p class="text-sm text-gray-600 mb-3">Choisissez un groupe pour g√©n√©rer sa liste.</p>
                    <form method="get" action="" class="flex gap-3">
                        <select id="cohort-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- S√©lectionnez un groupe --</option>
                            {% load academics_extras %}
                            {% get_all_cohorts as cohorts %}
                            {% for cohort in cohorts %}
                            <option value="{% url 'reports:cohort_students' cohort.id %}">{{ cohort.name }} - {{ cohort.subject.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" onclick="window.open(document.getElementById('cohort-select').value, '_blank')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">G√©n√©rer</button>
                    </form>
                </div>
                <div class="flex items-center justify-between p-4 bg-white rounded-lg border">
                    <div>
                        <h4 class="font-semibold text-gray-800">Fid√©lisation (CSV)</h4>
                        <p class="text-sm text-gray-600">√âtudiants ayant au moins 2 inscriptions.</p>
                    </div>
                    <a href="{% url 'reports:retained_students_csv' %}" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">T√©l√©charger CSV</a>
                </div>
            </div>

            <!-- Tab: S√©ances -->
            <div x-show="tab==='seances'" x-cloak class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border border-green-200">
                    <h3 class="font-semibold text-green-800 mb-1">Rapports S√©ances et Pr√©sences</h3>
                    <p class="text-sm text-gray-700">D√©tails des s√©ances: profs, remplacements, reports, statuts.</p>
                </div>
                <div class="p-4 bg-white rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">S√©ances par groupe</h4>
                    <p class="text-sm text-gray-600 mb-3">S√©lectionnez un groupe puis g√©n√©rez le rapport.</p>
                    <form method="get" action="" class="flex gap-3">
                        <select id="cohort-sessions-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                            <option value="">-- S√©lectionnez un groupe --</option>
                            {% for cohort in cohorts %}
                            <option value="{% url 'reports:cohort_sessions' cohort.id %}">{{ cohort.name }} - {{ cohort.subject.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" onclick="window.open(document.getElementById('cohort-sessions-select').value, '_blank')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">G√©n√©rer</button>
                    </form>
                </div>
            </div>

            <!-- Tab: Paiements -->
            <div x-show="tab==='paiements'" x-cloak class="space-y-4">
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <h3 class="font-semibold text-yellow-800 mb-1">Rapports Paiements</h3>
                    <p class="text-sm text-gray-700">Paiements √©tudiants mensuels et paie des professeurs.</p>
                </div>
                <div class="p-4 bg-white rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">Paiements √©tudiants mensuels</h4>
                    <p class="text-sm text-gray-600 mb-3">Rapport des paiements re√ßus par mois.</p>
                    <form method="get" action="{% url 'reports:payments_monthly' %}" target="_blank" class="flex gap-3">
                        <select name="month" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
                            <option value="1">Janvier</option>
                            <option value="2">F√©vrier</option>
                            <option value="3">Mars</option>
                            <option value="4">Avril</option>
                            <option value="5">Mai</option>
                            <option value="6">Juin</option>
                            <option value="7">Juillet</option>
                            <option value="8">Ao√ªt</option>
                            <option value="9">Septembre</option>
                            <option value="10">Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12" selected>D√©cembre</option>
                        </select>
                        <input type="number" name="year" value="2025" min="2020" max="2030" class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
                        <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">G√©n√©rer</button>
                    </form>
                </div>
                <div class="p-4 bg-white rounded-lg border">
                    <h4 class="font-semibold text-gray-800 mb-2">Paie des professeurs</h4>
                    <p class="text-sm text-gray-600 mb-3">Heures et montants dus (filtre p√©riode optionnel).</p>
                    <form method="get" action="{% url 'reports:teacher_payroll' %}" target="_blank" class="flex gap-3 flex-wrap">
                        <div class="flex gap-3 flex-1">
                            <input type="date" name="start" placeholder="Date d√©but (optionnel)" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
                            <input type="date" name="end" placeholder="Date fin (optionnel)" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 outline-none">
                        </div>
                        <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium transition shadow-sm">G√©n√©rer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
