{% extends 'base.html' %}

{% block content %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 gap-4">
        <div>
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Bienvenue, {{ request.user.first_name }}</h2>
            <p class="text-sm text-gray-500 mt-1">{{ today|date:"l d F Y" }}</p>
        </div>
        {% if not is_teacher %}
        <button hx-get="{% url 'students:enrollment_form' %}" hx-target="body" hx-swap="beforeend"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
            + Inscription
        </button>
        {% endif %}
    </div>

    {% if is_teacher %}
    <!-- STATS PROF -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <p class="text-xs text-blue-600 font-medium">Ã‰tudiants</p>
            <h3 class="text-2xl font-bold text-blue-800">{{ total_students }}</h3>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <p class="text-xs text-purple-600 font-medium">Mes Classes</p>
            <h3 class="text-2xl font-bold text-purple-800">{{ my_cohorts.count }}</h3>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <p class="text-xs text-green-600 font-medium">Cours (mois)</p>
            <h3 class="text-2xl font-bold text-green-800">{{ completed_this_month }}</h3>
        </div>
    </div>

    <!-- MES CLASSES -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 mb-6 p-4">
        <h3 class="font-bold text-gray-800 mb-3">Mes Classes</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for cohort in my_cohorts %}
            <a href="{% url 'academics:detail' cohort.id %}" class="border border-gray-200 rounded p-3 hover:border-blue-400 hover:bg-blue-50 transition">
                <h4 class="font-bold text-sm text-gray-800">{{ cohort.name }}</h4>
                <p class="text-xs text-gray-600">{{ cohort.subject }} - {{ cohort.level }} â€¢ {{ cohort.enrollments.count }} Ã©tuds</p>
            </a>
            {% empty %}
            <p class="text-gray-400 italic text-xs col-span-2">Aucune classe</p>
            {% endfor %}
        </div>
    </div>

    {% else %}
    <!-- STATS ADMIN -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded border border-blue-200">
            <p class="text-xs text-blue-600 font-medium">Ã‰tudiants</p>
            <h3 class="text-xl font-bold text-blue-800">{{ total_students }}</h3>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-3 rounded border border-green-200">
            <p class="text-xs text-green-600 font-medium">Revenus</p>
            <h3 class="text-lg font-bold text-green-800">{{ academic_year_income|floatformat:0|truncatewords:2 }}</h3>
        </div>
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-3 rounded border border-amber-200">
            <p class="text-xs text-amber-600 font-medium">Frais</p>
            <h3 class="text-lg font-bold text-amber-800">{{ registration_fees_total|floatformat:0|truncatewords:2 }}</h3>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-3 rounded border border-purple-200">
            <p class="text-xs text-purple-600 font-medium">Cours</p>
            <h3 class="text-lg font-bold text-purple-800">{{ sessions.count }}</h3>
        </div>
    </div>

    <!-- FILTRES + GRAPHIQUES -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-4">
        <form method="get" class="flex flex-col sm:flex-row gap-2 sm:gap-3 items-start sm:items-end">
            <div class="flex-1">
                <label class="text-xs font-medium text-gray-600 block mb-1">AnnÃ©e AcadÃ©mique</label>
                <select name="year" onchange="this.form.submit()" class="w-full px-2 py-1 border border-gray-300 rounded text-xs">
                    {% for year in all_academic_years %}
                    <option value="{{ year.id }}" {% if selected_year.id == year.id %}selected{% endif %}>{{ year.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <a href="{% url 'dashboard' %}" class="bg-gray-200 text-gray-700 px-3 py-1 rounded text-xs font-medium">RÃ©initialiser</a>
        </form>
    </div>

    <!-- FILTRES ACADÃ‰MIQUE, LANGUE, MODALITÃ‰ & TYPE -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-4">
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
            <div class="flex flex-col sm:flex-row gap-3 flex-1">
                <!-- Filtre AnnÃ©e AcadÃ©mique -->
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ğŸ“… AnnÃ©e AcadÃ©mique</label>
                    <select id="yearFilter" onchange="updateDashboard()" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% for year in all_academic_years %}
                        <option value="{{ year.id }}" {% if year.id == selected_year.id %}selected{% endif %}>
                            {{ year.start_date|date:"Y" }}-{{ year.end_date|date:"Y" }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Filtre Langue -->
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ğŸ—£ï¸ Filtre Langue</label>
                    <select id="languageFilter" onchange="updateDashboard()" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ğŸ“Š Toutes les Langues</option>
                        {% for lang in all_languages %}
                        <option value="{{ lang.id }}" {% if lang.id|stringformat:"s" == filter_language %}selected{% endif %}>
                            {{ lang.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtre ModalitÃ© -->
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ğŸ  ModalitÃ©</label>
                    <select id="modalityFilter" onchange="updateDashboard()" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ğŸ“Š Toutes les ModalitÃ©s</option>
                        <option value="IN_PERSON" {% if filter_modality == 'IN_PERSON' %}selected{% endif %}>ğŸ« PrÃ©sentiel</option>
                        <option value="ONLINE" {% if filter_modality == 'ONLINE' %}selected{% endif %}>ğŸ’» En Ligne</option>
                    </select>
                </div>

                <!-- Filtre Type -->
                <div class="flex-1">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">ğŸ‘¥ Type</label>
                    <select id="typeFilter" onchange="updateDashboard()" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ğŸ“Š Tous les Types</option>
                        <option value="group" {% if filter_type == 'group' %}selected{% endif %}>ğŸ‘¥ Groupe</option>
                        <option value="individual" {% if filter_type == 'individual' %}selected{% endif %}>ğŸ‘¤ Individuel</option>
                    </select>
                </div>
            </div>
            
            <button onclick="resetFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition whitespace-nowrap">
                ğŸ”„ RÃ©initialiser
            </button>
        </div>
    </div>

    <!-- FILTRES INTERACTIFS DES GRAPHIQUES -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-4">
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
            <div class="flex flex-wrap gap-2">
                <button onclick="switchPeriod('month')" class="period-btn active px-4 py-2 rounded-lg font-medium text-sm transition" data-period="month">
                    ğŸ“… Par Mois
                </button>
                <button onclick="switchPeriod('quarter')" class="period-btn px-4 py-2 rounded-lg font-medium text-sm transition" data-period="quarter">
                    ğŸ“Š Par Trimestre
                </button>
                <button onclick="switchPeriod('year')" class="period-btn px-4 py-2 rounded-lg font-medium text-sm transition" data-period="year">
                    ğŸ“ˆ AnnÃ©e ComplÃ¨te
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleChart('revenueDetail')" class="px-3 py-2 rounded text-xs font-medium bg-green-100 text-green-700 hover:bg-green-200 transition">
                    ğŸ’° DÃ©tails Revenus
                </button>
                <button onclick="toggleChart('feesDetail')" class="px-3 py-2 rounded text-xs font-medium bg-amber-100 text-amber-700 hover:bg-amber-200 transition">
                    ğŸ“ DÃ©tails Frais
                </button>
            </div>
        </div>
    </div>

    <!-- 4 GRAPHIQUES EN 2x2 GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96" id="monthlyChartContainer">
            <h3 class="font-bold text-sm text-gray-700 mb-2">ğŸ“ˆ Revenus par <span id="period-label">Mois</span></h3>
            <canvas id="monthlyChart"></canvas>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96" id="quarterlyChartContainer">
            <h3 class="font-bold text-sm text-gray-700 mb-2">ğŸ“Š Revenus par Trimestre</h3>
            <canvas id="quarterlyChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-sm text-gray-700 mb-2">ğŸ’° Frais + Revenus</h3>
            <canvas id="comparisonChart"></canvas>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-sm text-gray-700 mb-2">ğŸ—£ï¸ Revenus par Langue</h3>
            <canvas id="languageChart"></canvas>
        </div>
    </div>

    <!-- COMPARAISON MODALITÃ‰ & TYPE (2 graphiques) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-sm text-gray-700 mb-2">ğŸ  PrÃ©sentiel vs En Ligne</h3>
            <canvas id="modalityChart"></canvas>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-sm text-gray-700 mb-2">ğŸ‘¥ Groupe vs Individuel</h3>
            <canvas id="typeChart"></canvas>
        </div>
    </div>

    <!-- DÃ‰TAILS REVENUS (CachÃ© par dÃ©faut) -->
    <div id="revenueDetail" class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-4 hidden">
        <h3 class="font-bold text-gray-800 mb-3">ğŸ“Š DÃ©tails des Revenus</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-green-50 p-3 rounded border border-green-200">
                <p class="text-xs text-green-600 font-medium">Revenus Totaux</p>
                <p class="text-xl font-bold text-green-800">{{ academic_year_income|floatformat:0 }}</p>
                <p class="text-xs text-green-600 mt-1">DZD</p>
            </div>
            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <p class="text-xs text-blue-600 font-medium">Moyenne/Mois</p>
                <p class="text-xl font-bold text-blue-800">
                    {% if selected_year and selected_year.start_date %}
                        {{ academic_year_income|floatformat:0|add:0|divisibleby:12|default:0 }}
                    {% else %}
                        â€”
                    {% endif %}
                </p>
                <p class="text-xs text-blue-600 mt-1">DZD</p>
            </div>
            <div class="bg-purple-50 p-3 rounded border border-purple-200">
                <p class="text-xs text-purple-600 font-medium">Meilleur Mois</p>
                <p class="text-xl font-bold text-purple-800" id="bestMonth">â€”</p>
            </div>
            <div class="bg-orange-50 p-3 rounded border border-orange-200">
                <p class="text-xs text-orange-600 font-medium">Croissance</p>
                <p class="text-xl font-bold text-orange-800" id="growth">â€”</p>
            </div>
        </div>
    </div>

    <!-- DÃ‰TAILS FRAIS (CachÃ© par dÃ©faut) -->
    <div id="feesDetail" class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 mb-4 hidden">
        <h3 class="font-bold text-gray-800 mb-3">ğŸ“ DÃ©tails des Frais d'Inscription</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-amber-50 p-3 rounded border border-amber-200">
                <p class="text-xs text-amber-600 font-medium">Frais Totaux CollectÃ©s</p>
                <p class="text-xl font-bold text-amber-800">{{ registration_fees_total|floatformat:0 }}</p>
                <p class="text-xs text-amber-600 mt-1">DZD</p>
            </div>
            <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                <p class="text-xs text-yellow-600 font-medium">Ã‰tudiants PayÃ©s</p>
                <p class="text-xl font-bold text-yellow-800">{{ paid_registrations_count }}</p>
                <p class="text-xs text-yellow-600 mt-1">Ã©tudiants</p>
            </div>
            <div class="bg-red-50 p-3 rounded border border-red-200">
                <p class="text-xs text-red-600 font-medium">Ã‰tudiants Non PayÃ©s</p>
                <p class="text-xl font-bold text-red-800" id="unpaidCount">â€”</p>
                <p class="text-xs text-red-600 mt-1">Ã©tudiants</p>
            </div>
            <div class="bg-green-50 p-3 rounded border border-green-200">
                <p class="text-xs text-green-600 font-medium">Taux de Collecte</p>
                <p class="text-xl font-bold text-green-800" id="collectRate">â€”</p>
                <p class="text-xs text-green-600 mt-1">%</p>
            </div>
        </div>
    </div>

    <!-- RÃ‰SUMÃ‰ COMPACT -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
        <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-4 rounded-lg border border-slate-200">
            <h3 class="font-bold text-gray-800 text-sm mb-3">RÃ©sumÃ© AnnÃ©e</h3>
            <div class="space-y-2 text-xs">
                <div class="flex justify-between"><span>Revenus</span><span class="font-bold text-green-600">{{ academic_year_income|floatformat:0 }}</span></div>
                <div class="flex justify-between pb-2 border-b"><span>Frais</span><span class="font-bold text-amber-600">{{ registration_fees_total|floatformat:0 }}</span></div>
                <div class="flex justify-between pt-2"><span class="font-medium">TOTAL</span><span class="font-bold text-green-700">{{ academic_year_income|floatformat:0|add:registration_fees_total|floatformat:0 }}</span></div>
            </div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <h3 class="font-bold text-gray-800 text-sm mb-3">DÃ©tails Frais</h3>
            <div class="space-y-2 text-xs">
                <div class="flex justify-between"><span>Ã‰tudiants PayÃ©s</span><span class="font-bold">{{ paid_registrations_count }}</span></div>
                {% if selected_year %}<div class="flex justify-between"><span>Prix Unitaire</span><span class="font-bold">{{ selected_year.registration_fee_amount }} DZD</span></div>{% endif %}
                <div class="flex justify-between pt-2 border-t"><span>AnnÃ©e</span><span class="font-bold">{% if selected_year %}{{ selected_year.label }}{% else %}â€”{% endif %}</span></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
    // ============ DONNÃ‰ES GLOBALES ============
    const monthlyData = {{ monthly_breakdown|safe }};
    const quarterlyData = {{ quarterly_data|safe }};
    const registrationFees = {{ registration_fees_total }};
    const academicIncome = {{ academic_year_income }};
    const languagesIncome = {{ languages_income|safe }};
    const modalityIncome = {{ modality_income|safe }};
    const typeIncome = {{ type_income|safe }};
    
    const monthlyDataObj = {};
    const quartValues = {};
    
    // Parse monthly data
    monthlyData.forEach(d => {
        monthlyDataObj[d.name] = d.value;
    });
    
    // Parse quarterly data
    Object.keys(quarterlyData).forEach(q => {
        quartValues[q] = quarterlyData[q];
    });

    // ============ CONFIGURATION GLOBALE CHART.JS ============
    const globalOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    font: { size: 12 },
                    padding: 15,
                    usePointStyle: true,
                    color: '#666'
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 12, weight: 'bold' },
                bodyFont: { size: 11 },
                callbacks: {
                    label: function(context) {
                        const label = context.dataset.label || '';
                        const value = context.parsed.y || context.parsed;
                        return label + ': ' + value.toLocaleString('fr-DZ') + ' DZD';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: (value) => value.toLocaleString('fr-DZ') + ' DZD',
                    color: '#666',
                    font: { size: 11 }
                },
                grid: { color: '#f0f0f0' }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#666', font: { size: 10 } }
            }
        }
    };

    // ============ INSTANCES CHART.JS ============
    let monthlyChart, quarterlyChart, comparisonChart, languageChart, modalityChart, typeChart;

    // ============ FONCTION : METTRE Ã€ JOUR LE DASHBOARD ============
    function updateDashboard() {
        const yearId = document.getElementById('yearFilter').value;
        const langId = document.getElementById('languageFilter').value;
        const modality = document.getElementById('modalityFilter').value;
        const type = document.getElementById('typeFilter').value;
        
        let url = new URL(window.location.href);
        url.searchParams.set('year', yearId);
        if (langId) url.searchParams.set('language', langId);
        else url.searchParams.delete('language');
        if (modality) url.searchParams.set('modality', modality);
        else url.searchParams.delete('modality');
        if (type) url.searchParams.set('type', type);
        else url.searchParams.delete('type');
        
        window.location.href = url.toString();
    }

    // ============ FONCTION : RÃ‰INITIALISER LES FILTRES ============
    function resetFilters() {
        document.getElementById('yearFilter').value = '{{ selected_year.id }}';
        document.getElementById('languageFilter').value = '';
        document.getElementById('modalityFilter').value = '';
        document.getElementById('typeFilter').value = '';
        updateDashboard();
    }

    // ============ FONCTION : CHANGER LA PÃ‰RIODE ============
    function switchPeriod(period) {
        // Mettre Ã  jour les boutons actifs
        document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.add('bg-gray-100', 'text-gray-700');
            if (btn.dataset.period === period) {
                btn.classList.add('active', 'bg-blue-600', 'text-white');
            }
        });

        // Changer le label du graphique
        const labels = {
            'month': 'Mois',
            'quarter': 'Trimestre',
            'year': 'AnnÃ©e'
        };
        document.getElementById('period-label').textContent = labels[period];

        // Afficher/Masquer les graphiques appropriÃ©s
        document.getElementById('monthlyChartContainer').style.display = period === 'month' ? 'block' : 'none';
        document.getElementById('quarterlyChartContainer').style.display = period === 'quarter' ? 'block' : 'none';

        if (period === 'month') {
            setTimeout(() => monthlyChart.resize(), 100);
        } else if (period === 'quarter') {
            setTimeout(() => quarterlyChart.resize(), 100);
        }
    }

    // ============ FONCTION : TOGGLE DÃ‰TAILS ============
    function toggleChart(id) {
        const element = document.getElementById(id);
        element.classList.toggle('hidden');

        // Calculer les statistiques si le dÃ©tail des revenus est affichÃ©
        if (id === 'revenueDetail' && !element.classList.contains('hidden')) {
            calculateRevenueStats();
        }

        // Calculer les statistiques si le dÃ©tail des frais est affichÃ©
        if (id === 'feesDetail' && !element.classList.contains('hidden')) {
            calculateFeesStats();
        }
    }

    // ============ FONCTION : CALCULER STATS REVENUS ============
    function calculateRevenueStats() {
        const values = Object.values(monthlyDataObj);
        const maxValue = Math.max(...values);
        const maxMonth = Object.keys(monthlyDataObj)[Object.values(monthlyDataObj).indexOf(maxValue)];
        const firstVal = values[0] || 0;
        const lastVal = values[values.length - 1] || 0;
        const growth = firstVal > 0 ? (((lastVal - firstVal) / firstVal) * 100).toFixed(1) : 0;

        document.getElementById('bestMonth').textContent = maxMonth + ' (' + maxValue.toLocaleString('fr-DZ') + ' DZD)';
        document.getElementById('growth').textContent = (growth >= 0 ? '+' : '') + growth + '%';
    }

    // ============ FONCTION : CALCULER STATS FRAIS ============
    function calculateFeesStats() {
        const paidCount = {{ paid_registrations_count }};
        const totalStudents = paidCount + Math.max(1, Math.ceil(paidCount * 0.15));

        document.getElementById('unpaidCount').textContent = (totalStudents - paidCount);
        document.getElementById('collectRate').textContent = paidCount > 0 ? ((paidCount / totalStudents) * 100).toFixed(1) : '0';
    }

    // ============ CRÃ‰ER GRAPHIQUES INITIAUX ============
    function initCharts() {
        // === GRAPHIQUE MENSUEL ===
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        monthlyChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: Object.keys(monthlyDataObj),
                datasets: [{
                    label: 'Revenus',
                    data: Object.values(monthlyDataObj),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#10b981',
                    pointHoverRadius: 7,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                ...globalOptions,
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const monthIdx = elements[0].index;
                        const monthName = Object.keys(monthlyDataObj)[monthIdx];
                        const value = Object.values(monthlyDataObj)[monthIdx];
                        alert(`ğŸ“Š ${monthName}\nRevenus: ${value.toLocaleString('fr-DZ')} DZD`);
                    }
                }
            }
        });

        // === GRAPHIQUE TRIMESTRIEL ===
        const quarterlyCtx = document.getElementById('quarterlyChart').getContext('2d');
        quarterlyChart = new Chart(quarterlyCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(quartValues),
                datasets: [{
                    label: 'Revenus par Trimestre',
                    data: Object.values(quartValues),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',   // Q1 - Bleu
                        'rgba(34, 197, 94, 0.7)',    // Q2 - Vert
                        'rgba(245, 158, 11, 0.7)',   // Q3 - Orange
                        'rgba(168, 85, 247, 0.7)'    // Q4 - Violet
                    ],
                    borderColor: [
                        'rgb(59, 130, 246)',
                        'rgb(34, 197, 94)',
                        'rgb(245, 158, 11)',
                        'rgb(168, 85, 247)'
                    ],
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                ...globalOptions,
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const qIdx = elements[0].index;
                        const quarters = Object.keys(quartValues);
                        const qName = quarters[qIdx];
                        const value = Object.values(quartValues)[qIdx];
                        alert(`ğŸ“Š ${qName}\nRevenus: ${value.toLocaleString('fr-DZ')} DZD`);
                    }
                }
            }
        });

        // === GRAPHIQUE COMPARAISON FRAIS + REVENUS ===
        const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
        comparisonChart = new Chart(comparisonCtx, {
            type: 'bar',
            data: {
                labels: ['Frais', 'Revenus Cours'],
                datasets: [{
                    label: 'CollectÃ© (DZD)',
                    data: [registrationFees, academicIncome],
                    backgroundColor: [
                        'rgba(251, 191, 36, 0.7)',    // Frais - Jaune
                        'rgba(52, 211, 153, 0.7)'     // Revenus - Vert
                    ],
                    borderColor: [
                        'rgb(251, 191, 36)',
                        'rgb(52, 211, 153)'
                    ],
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                ...globalOptions,
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const labels = ['Frais d\'inscription', 'Revenus des cours'];
                        const values = [registrationFees, academicIncome];
                        alert(`ğŸ’° ${labels[idx]}\nMontant: ${values[idx].toLocaleString('fr-DZ')} DZD`);
                    }
                }
            }
        });

        // === GRAPHIQUE PAR LANGUE ===
        const languageCtx = document.getElementById('languageChart').getContext('2d');
        const languageNames = Object.keys(languagesIncome);
        const languageValues = Object.values(languagesIncome);
        
        const languageColors = [
            'rgba(59, 130, 246, 0.7)',
            'rgba(34, 197, 94, 0.7)',
            'rgba(245, 158, 11, 0.7)',
            'rgba(239, 68, 68, 0.7)',
            'rgba(168, 85, 247, 0.7)',
            'rgba(236, 72, 153, 0.7)',
            'rgba(14, 165, 233, 0.7)',
            'rgba(34, 197, 94, 0.7)',
            'rgba(251, 146, 60, 0.7)',
            'rgba(107, 114, 128, 0.7)'
        ];

        languageChart = new Chart(languageCtx, {
            type: 'bar',
            data: {
                labels: languageNames,
                datasets: [{
                    label: 'Revenus par Langue',
                    data: languageValues,
                    backgroundColor: languageColors.slice(0, languageNames.length),
                    borderColor: languageColors.map(c => c.replace('0.7', '1')).slice(0, languageNames.length),
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                ...globalOptions,
                indexAxis: 'y',  // Barres horizontales pour meilleure lisibilitÃ©
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const langName = languageNames[idx];
                        const value = languageValues[idx];
                        alert(`ğŸ—£ï¸ ${langName}\nRevenus: ${value.toLocaleString('fr-DZ')} DZD`);
                    }
                }
            }
        });

        // === GRAPHIQUE MODALITÃ‰ ===
        const modalityCtx = document.getElementById('modalityChart').getContext('2d');
        const modalityNames = Object.keys(modalityIncome);
        const modalityValues = Object.values(modalityIncome);

        modalityChart = new Chart(modalityCtx, {
            type: 'bar',
            data: {
                labels: modalityNames,
                datasets: [{
                    label: 'Revenus',
                    data: modalityValues,
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(34, 197, 94, 0.7)'
                    ],
                    borderColor: [
                        'rgb(59, 130, 246)',
                        'rgb(34, 197, 94)'
                    ],
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                ...globalOptions,
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const name = modalityNames[idx];
                        const value = modalityValues[idx];
                        alert(`ğŸ  ${name}\nRevenus: ${value.toLocaleString('fr-DZ')} DZD`);
                    }
                }
            }
        });

        // === GRAPHIQUE TYPE ===
        const typeCtx = document.getElementById('typeChart').getContext('2d');
        const typeNames = Object.keys(typeIncome);
        const typeValues = Object.values(typeIncome);

        typeChart = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: typeNames,
                datasets: [{
                    label: 'Revenus',
                    data: typeValues,
                    backgroundColor: [
                        'rgba(168, 85, 247, 0.7)',
                        'rgba(239, 68, 68, 0.7)'
                    ],
                    borderColor: [
                        'rgb(168, 85, 247)',
                        'rgb(239, 68, 68)'
                    ],
                    borderWidth: 2,
                    borderRadius: 6
                }]
            },
            options: {
                ...globalOptions,
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const name = typeNames[idx];
                        const value = typeValues[idx];
                        alert(`ğŸ‘¥ ${name}\nRevenus: ${value.toLocaleString('fr-DZ')} DZD`);
                    }
                }
            }
        });
    }

    // ============ INITIALISATION ============
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        
        // Style des boutons de pÃ©riode au chargement
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.add('bg-gray-100', 'text-gray-700');
            if (btn.dataset.period === 'month') {
                btn.classList.remove('bg-gray-100', 'text-gray-700');
                btn.classList.add('active', 'bg-blue-600', 'text-white');
            }
        });
    });
    </script>
    {% endif %}

    <!-- PLANNING DU JOUR (pour tous) -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <h3 class="font-bold text-gray-800 mb-3">ğŸ“… Planning du Jour</h3>
        {% if sessions %}
        <div class="space-y-2">
            {% for session in sessions %}
            <div class="flex items-center justify-between p-2 sm:p-3 border border-gray-200 rounded hover:bg-gray-50 transition">
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-sm text-gray-800">{{ session.start_time|time:"H:i" }} - {{ session.cohort.name }}</p>
                    <p class="text-xs text-gray-600">{{ session.teacher.first_name }} â€¢ {{ session.classroom.name }}</p>
                </div>
                {% if session.status == 'SCHEDULED' %}
                <a href="{% url 'academics:session_detail' session.id %}" class="ml-2 bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-medium whitespace-nowrap">Appel</a>
                {% else %}
                <span class="ml-2 text-xs text-gray-500 whitespace-nowrap">{{ session.status }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-400 italic text-xs">Aucun cours aujourd'hui</p>
        {% endif %}
    </div>
{% endblock %}
