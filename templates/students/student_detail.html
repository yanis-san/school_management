{% extends 'base.html' %}

{% block title %}Profil : {{ student.first_name }} {{ student.last_name }}{% endblock %}

{% block content %}
<div class="space-y-6">

    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6">
            {% if student.profile_picture %}
                <img src="{{ student.profile_picture.url }}"
                     alt="{{ student.first_name }} {{ student.last_name }}"
                     class="w-24 h-32 sm:w-28 sm:h-36 rounded-lg object-cover border border-gray-200"
                     style="object-position: center top;">
            {% else %}
                <div class="w-24 h-32 sm:w-28 sm:h-36 rounded-lg bg-gray-100 text-gray-700 flex items-center justify-center font-bold text-2xl border border-gray-200">
                    {{ student.first_name|slice:":1" }}{{ student.last_name|slice:":1" }}
                </div>
            {% endif %}
            <div class="flex-1">
                <div class="text-xs uppercase tracking-wide text-gray-500">√âtudiant</div>
                <h1 class="text-2xl font-bold text-gray-900 mt-1">{{ student.last_name }} {{ student.first_name }}</h1>
                <div class="mt-2 flex items-center gap-2 flex-wrap">
                    <div class="text-sm font-mono bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200">
                        #{{ student.student_code }}
                    </div>
                    {% if student.sex %}
                        <span class="text-xs font-semibold bg-gray-100 text-gray-700 px-2 py-0.5 rounded border border-gray-200">Sexe: {{ student.sex }}</span>
                    {% endif %}
                    {% if current_academic_year %}
                        <span id="annual-fee-badge" class="text-xs font-bold px-2 py-0.5 rounded cursor-pointer hover:opacity-80 transition border border-gray-200 bg-gray-50 text-gray-800"
                              onclick="toggleAnnualFee({{ student.id }})"
                              title="Cliquer pour marquer comme {{ annual_fee_paid|yesno:'non pay√©,pay√©' }}">
                            {% if annual_fee_paid %}
                                <span class="bg-emerald-100 text-emerald-900 px-2 py-0.5 rounded">‚úì Frais {{ current_academic_year.label }}: Pay√©</span>
                            {% else %}
                                <span class="bg-rose-100 text-rose-900 px-2 py-0.5 rounded">‚úó Frais {{ current_academic_year.label }}: Non pay√©</span>
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
                <button id="edit-student-btn" hx-get="{% url 'students:edit' student.id %}" hx-target="body" hx-swap="beforeend"
                        class="w-full sm:w-auto bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition" title="Ctrl + M">
                    ‚úèÔ∏è Modifier
                </button>
                <button id="new-enrollment-detail-btn" hx-get="{% url 'students:enrollment_form' %}?student_id={{ student.id }}" hx-target="body" hx-swap="beforeend"
                        class="w-full sm:w-auto bg-gray-100 hover:bg-gray-200 text-gray-900 px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition border border-gray-300" title="Alt + A">
                    <span>+</span> Nouvelle Inscription
                </button>
                <a href="{% url 'students:list' %}" class="w-full sm:w-auto text-center text-gray-600 hover:text-gray-900 px-3 py-2">
                    ‚Üê Retour
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Coordonn√©es</h3>
                <div class="space-y-3 text-sm">
                    {% if student.birth_date %}
                    <div>
                        <span class="block text-gray-500 text-xs uppercase">Date de naissance</span>
                        <span class="font-medium text-gray-800">{{ student.birth_date|date:"d/m/Y" }}</span>
                        {% if student.age %}
                            <span class="ml-2 text-indigo-600 font-semibold">({{ student.age }} ans)</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div>
                        <span class="block text-gray-500 text-xs uppercase">T√©l√©phone</span>
                        <span class="font-medium text-gray-800">{{ student.phone }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs uppercase">Email</span>
                        <span class="font-medium text-gray-800">{{ student.email|default:"Non renseign√©" }}</span>
                    </div>
                    <div>
                        <span class="block text-gray-500 text-xs uppercase">Inscrit le</span>
                        <span class="font-medium text-gray-800">{{ student.created_at|date:"d M Y" }}</span>
                    </div>
                </div>

                {% if student.id_card_front or student.id_card_back %}
                    <div class="mt-5 p-4 border border-gray-100 rounded-lg bg-gray-50" x-data="{ side: '{{ student.id_card_front|yesno:"front,back" }}' }">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-sm font-semibold text-gray-700">Carte d'identit√©</div>
                        <div class="inline-flex gap-2">
                            {% if student.id_card_front %}
                            <button type="button" class="px-3 py-1 text-xs rounded-lg border" :class="side === 'front' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-200'" @click="side='front'">Recto</button>
                            {% endif %}
                            {% if student.id_card_back %}
                            <button type="button" class="px-3 py-1 text-xs rounded-lg border" :class="side === 'back' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-200'" @click="side='back'">Verso</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="relative overflow-hidden rounded-lg border border-gray-200 bg-white">
                        {% if student.id_card_front %}
                        <img x-show="side === 'front'" src="{{ student.id_card_front.url }}" alt="Carte d'identit√© recto" class="w-full object-contain max-h-56">
                        {% endif %}
                        {% if student.id_card_back %}
                        <img x-show="side === 'back'" x-cloak src="{{ student.id_card_back.url }}" alt="Carte d'identit√© verso" class="w-full object-contain max-h-56">
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <!-- Section: Inscriptions Actuelles -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4">Inscriptions Actuelles</h3>
                {% if active_enrollments %}
                    {% for enrollment in active_enrollments %}
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                            <div class="p-6 bg-gray-50 border-b border-gray-100 flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h3 class="font-bold text-lg text-indigo-900">{{ enrollment.cohort.name }}</h3>
                                        <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full font-bold">
                                            {{ enrollment.cohort.subject.name }} ‚Ä¢ {{ enrollment.cohort.level.name }}
                                        </span>
                                        <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-bold">En cours</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-1">
                                        Prof: {{ enrollment.cohort.teacher.first_name }} ‚Ä¢ P√©riode: {{ enrollment.cohort.start_date|date:"d/m/Y" }} - {{ enrollment.cohort.end_date|date:"d/m/Y" }}
                                    </p>
                                    <div class="mt-3 flex items-center gap-3">
                                        <div class="bg-white border border-gray-200 rounded px-3 py-2">
                                            <div class="text-xs text-gray-500 font-medium">üí∞ Tarif appliqu√©</div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="text-lg font-bold text-gray-900">{{ enrollment.tariff.amount }} DA</span>
                                                {% if enrollment.is_standard_tariff %}
                                                    <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full font-semibold">Tarif standard</span>
                                                {% else %}
                                                    <span class="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded-full font-semibold">Tarif personnalis√©</span>
                                                {% endif %}
                                            </div>
                                            <button hx-get="{% url 'students:edit_tariff' enrollment.id %}" hx-target="body" hx-swap="beforeend"
                                                    class="mt-2 text-xs px-2 py-1 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 font-semibold transition">
                                                ‚úèÔ∏è Modifier
                                            </button>
                                        </div>
                                        {% if enrollment.discount %}
                                        <div class="bg-white border border-gray-200 rounded px-3 py-2">
                                            <div class="text-xs text-gray-500 font-medium">üéÅ R√©duction</div>
                                            <div class="text-lg font-bold text-green-600 mt-1">-{{ enrollment.discount.amount }} DA</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-right space-y-2">
                                    {% if enrollment.balance_due > 0 %}
                                        <span class="block text-2xl font-bold text-red-600">-{{ enrollment.balance_due }} DA</span>
                                        <span class="text-xs text-red-400 font-medium">Reste √† payer</span>
                                    {% else %}
                                        <span class="block text-2xl font-bold text-green-600">Sold√©</span>
                                        <span class="text-xs text-green-500">Tout est pay√©</span>
                                    {% endif %}
                                    {% if enrollment.payment_plan == 'PACK' and enrollment.cohort.is_individual %}
                                    <div class="text-xs text-left bg-purple-50 border border-purple-200 rounded p-2 mt-2">
                                        <div class="font-semibold text-purple-800">Pack d'heures</div>
                                        <div class="text-purple-900 mt-1">
                                            Achet√©es: <span class="font-bold">{{ enrollment.hours_purchased }}h</span>
                                            ‚Ä¢ Consomm√©es: <span class="font-bold">{{ enrollment.hours_consumed }}h</span>
                                            ‚Ä¢ Restantes: <span class="font-bold">{{ enrollment.hours_remaining }}h</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="flex gap-2 justify-end flex-wrap">
                                        {% if enrollment.balance_due > 0 %}
                                        <a href="{% url 'finance:add_payment' enrollment.id %}" class="text-xs px-3 py-1 rounded bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 font-semibold">üí∞ Enregistrer paiement</a>
                                        {% endif %}
                                        <form method="post" action="{% url 'students:unenroll' enrollment.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="text-xs px-3 py-1 rounded bg-amber-50 text-amber-700 border border-amber-200 hover:bg-amber-100" onclick="return confirm('R√©silier cette inscription ?');">R√©silier</button>
                                        </form>
                                        <form method="post" action="{% url 'students:delete_enrollment' enrollment.id %}">
                                            {% csrf_token %}
                                            <button type="submit" class="text-xs px-3 py-1 rounded bg-red-50 text-red-700 border border-red-200 hover:bg-red-100" onclick="return confirm('Supprimer d√©finitivement cette inscription et ses donn√©es (paiements, pr√©sences) ?');">Supprimer</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Historique des paiements -->
                            {% if enrollment.payments.exists %}
                            <div class="p-4 bg-gray-50 border-t border-gray-200">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">üí≥ Paiements enregistr√©s</h4>
                                <div class="space-y-2">
                                    {% for payment in enrollment.payments.all %}
                                    <div class="flex items-center justify-between bg-white p-3 rounded border border-gray-200 text-sm">
                                        <div>
                                            <div class="text-gray-600">
                                                <span class="font-bold text-gray-900">{{ payment.amount|stringformat:"d" }} DA</span>
                                                ¬∑ {{ payment.date|date:"d/m/Y" }}
                                                ¬∑ <span class="text-xs bg-gray-100 px-2 py-0.5 rounded">{{ payment.get_method_display }}</span>
                                            </div>
                                            {% if payment.transaction_id %}
                                            <div class="text-xs text-gray-500 mt-1">
                                                R√©f: {{ payment.transaction_id }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <a href="{% url 'finance:edit_payment' payment.id %}"
                                               class="flex items-center gap-1 text-xs px-3 py-1.5 bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-lg hover:bg-yellow-100 font-semibold transition">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M4 13.5V20h6.5l8.232-8.232a2.5 2.5 0 10-3.536-3.536L7 16.5"/>
                                                </svg>
                                                Modifier
                                            </a>
                                            {% if payment.receipt %}
                                            <a href="{{ payment.receipt.url }}" target="_blank" 
                                               class="flex items-center gap-1 text-xs px-3 py-1.5 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded-lg hover:bg-indigo-100 font-semibold transition">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                </svg>
                                                Voir re√ßu
                                            </a>
                                            {% else %}
                                            <span class="text-xs text-gray-400 italic">Pas de re√ßu</span>
                                            {% endif %}
                                            
                                            <form method="post" action="{% url 'finance:delete_payment' payment.id %}" class="inline">
                                                {% csrf_token %}
                                                <button type="submit" 
                                                        onclick="return confirm('Supprimer ce paiement de {{ payment.amount }} DA ?')"
                                                        class="flex items-center gap-1 text-xs px-2 py-1.5 bg-red-50 text-red-700 border border-red-200 rounded-lg hover:bg-red-100 font-medium transition">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-sm text-gray-500">Aucune inscription en cours.</div>
                {% endif %}
            </div>

            <!-- Section: Historique des Inscriptions -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-800">Historique des Inscriptions</h3>
                    <a href="{% url 'students:export_history' student.id %}"
                       class="text-sm bg-gray-800 hover:bg-black text-white px-3 py-1.5 rounded-lg">Exporter CSV</a>
                </div>
                {% if past_enrollments %}
                    {% for enrollment in past_enrollments %}
                        <div class="border rounded-lg p-4 mb-3">
                            <div class="flex items-center gap-2">
                                <div class="font-semibold text-gray-800">{{ enrollment.cohort.name }}</div>
                                <div class="text-xs text-gray-500">{{ enrollment.cohort.subject.name }} ‚Ä¢ {{ enrollment.cohort.level.name }}</div>
                                {% if not enrollment.is_active %}
                                    <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full font-bold">R√©sili√©</span>
                                {% else %}
                                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full font-bold">Termin√©</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                P√©riode: {{ enrollment.cohort.start_date|date:"d/m/Y" }} - {{ enrollment.cohort.end_date|date:"d/m/Y" }} ‚Ä¢ Prof: {{ enrollment.cohort.teacher.get_full_name }}
                            </div>
                            <div class="mt-2 flex items-center gap-2">
                                <div class="text-xs font-medium text-gray-600">üí∞ Tarif: <span class="font-bold text-gray-800">{{ enrollment.tariff.amount }} DA</span></div>
                                {% if enrollment.is_standard_tariff %}
                                    <span class="bg-blue-50 text-blue-700 text-xs px-2 py-0.5 rounded font-semibold">Standard</span>
                                {% else %}
                                    <span class="bg-orange-50 text-orange-700 text-xs px-2 py-0.5 rounded font-semibold">Personnalis√©</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-sm text-gray-500">Aucun historique.</div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleAnnualFee(studentId) {
    // D√©terminer le statut actuel depuis le badge
    const badge = document.getElementById('annual-fee-badge');
    const isPaid = badge.querySelector('.bg-green-100\\/90') !== null;
    
    // Message de confirmation
    const action = isPaid ? 'NON PAY√â' : 'PAY√â';
    const message = isPaid 
        ? `Marquer les frais d'inscription comme NON PAY√âS ?\n\n‚ö†Ô∏è L'√©tudiant appara√Ætra comme n'ayant pas pay√©.`
        : `Confirmer le paiement des frais d'inscription ?\n\n‚úÖ L'√©tudiant sera marqu√© comme ayant pay√© les frais annuels.`;
    
    if (!confirm(message)) {
        return;
    }
    
    fetch(`/students/${studentId}/toggle-annual-fee/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recharger la page pour afficher le nouveau statut
            window.location.reload();
        } else {
            alert('Erreur: ' + (data.error || 'Impossible de modifier le statut'));
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification du statut');
    });
}

// Raccourci Alt+A pour Nouvelle Inscription
document.addEventListener('keydown', function(e) {
    if (e.altKey && e.key === 'a') {
        e.preventDefault();
        document.getElementById('new-enrollment-detail-btn').click();
    }
    // Raccourci Ctrl+M pour Modifier
    if (e.ctrlKey && e.key === 'm') {
        e.preventDefault();
        document.getElementById('edit-student-btn').click();
    }
});
</script>
{% endblock %}