{% extends 'base.html' %}

{% block content %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 gap-4">
        <div>
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Tableau de Bord Prospects</h2>
            <p class="text-sm text-gray-500 mt-1">Analyse compl√®te des prospects</p>
        </div>
        <a href="{% url 'prospects:list' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
            ‚Üê Retour √† la liste
        </a>
    </div>

    <!-- KPI CARDS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <p class="text-xs text-blue-600 font-medium">Prospects Total</p>
            <h3 class="text-3xl font-bold text-blue-800">{{ total_prospects }}</h3>
            <p class="text-xs text-blue-600 mt-2">üíº En portefeuille</p>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <p class="text-xs text-green-600 font-medium">Convertis</p>
            <h3 class="text-3xl font-bold text-green-800">{{ converted_count }}</h3>
            <p class="text-xs text-green-600 mt-2">‚úÖ Taux: {{ conversion_rate }}%</p>
        </div>
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg border border-amber-200">
            <p class="text-xs text-amber-600 font-medium">Conversions (Mois)</p>
            <h3 class="text-3xl font-bold text-amber-800">{{ converted_last_month }}</h3>
            <p class="text-xs text-amber-600 mt-2">üìÖ Ce mois</p>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <p class="text-xs text-purple-600 font-medium">Conversions ({{ current_quarter }})</p>
            <h3 class="text-3xl font-bold text-purple-800">{{ converted_last_quarter }}</h3>
            <p class="text-xs text-purple-600 mt-2">üìä Trimestre actuel</p>
        </div>
    </div>

    <!-- GRAPHIQUES PRINCIPAUX -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <!-- Conversions Timeline -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-gray-800 mb-3">üìà Conversions par Mois</h3>
            <canvas id="conversionsChart"></canvas>
        </div>

        <!-- Modalit√© (En ligne vs Pr√©sentiel) -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-gray-800 mb-3">üè† Pr√©f√©rences: En ligne vs Pr√©sentiel</h3>
            <canvas id="modalityChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <!-- Top Cours Demand√©s -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-gray-800 mb-3">üéì Cours Les Plus Demand√©s</h3>
            <canvas id="coursesChart"></canvas>
        </div>

        <!-- Top Activit√©s -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-gray-800 mb-3">üíº Types d'Activit√©s</h3>
            <canvas id="activitiesChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-4 mb-6">
        <!-- Sources -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 h-96">
            <h3 class="font-bold text-gray-800 mb-3">üì° Sources des Prospects</h3>
            <canvas id="sourcesChart"></canvas>
        </div>
    </div>

    <!-- STATISTIQUES TEXTE -->
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
        <h3 class="font-bold text-gray-800 mb-4">üìä R√©sum√© Cl√©</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
            <div class="border-l-4 border-blue-600 pl-4">
                <p class="text-gray-600 font-medium">Prospect Non Converti</p>
                <p class="text-2xl font-bold text-blue-800">{{ unconverted_count }}</p>
                <p class="text-xs text-gray-500 mt-1">√Ä contacter</p>
            </div>
            <div class="border-l-4 border-green-600 pl-4">
                <p class="text-gray-600 font-medium">Taux Conversion</p>
                <p class="text-2xl font-bold text-green-800">{{ conversion_rate }}%</p>
                <p class="text-xs text-gray-500 mt-1">Global</p>
            </div>
            <div class="border-l-4 border-orange-600 pl-4">
                <p class="text-gray-600 font-medium">Int√©r√™t Modalit√©</p>
                <p class="text-2xl font-bold text-orange-800">
                    {% if online_count > in_person_count %}
                        üíª En ligne
                    {% else %}
                        üè´ Pr√©sentiel
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500 mt-1">Plus populaire</p>
            </div>
            <div class="border-l-4 border-purple-600 pl-4">
                <p class="text-gray-600 font-medium">Tendance</p>
                <p class="text-2xl font-bold text-purple-800">
                    {% if converted_last_month > 0 %}
                        ‚ÜóÔ∏è Positive
                    {% else %}
                        ‚ÜòÔ∏è Faible
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500 mt-1">Conversions mois</p>
            </div>
        </div>
    </div>

    <!-- CHART.JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    {{ conversions_by_month|json_script:"conversions-data" }}
    {{ courses_data|json_script:"courses-data" }}
    {{ activities_data|json_script:"activities-data" }}
    {{ levels_data|json_script:"levels-data" }}
    {{ sources_data|json_script:"sources-data" }}

    <script>
        const globalOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        font: { size: 12 },
                        padding: 15,
                        usePointStyle: true,
                        color: '#666'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 12, weight: 'bold' },
                    bodyFont: { size: 11 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#666',
                        font: { size: 11 }
                    },
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#666', font: { size: 10 } }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // R√©cup√©rer les donn√©es JSON
            const conversionsData = JSON.parse(document.getElementById('conversions-data').textContent);
            const coursesData = JSON.parse(document.getElementById('courses-data').textContent);
            const activitiesData = JSON.parse(document.getElementById('activities-data').textContent);
            const levelsData = JSON.parse(document.getElementById('levels-data').textContent);
            const sourcesData = JSON.parse(document.getElementById('sources-data').textContent);

            console.log('conversionsData:', conversionsData);
            console.log('coursesData:', coursesData);
            console.log('activitiesData:', activitiesData);
            console.log('levelsData:', levelsData);
            console.log('sourcesData:', sourcesData);

            // V√©rifier les valeurs
            console.log('coursesNames:', Object.keys(coursesData));
            console.log('coursesValues:', Object.values(coursesData));
            console.log('activitiesNames:', Object.keys(activitiesData));
            console.log('activitiesValues:', Object.values(activitiesData));

            // === CONVERSIONS PAR MOIS ===
            if (Object.values(conversionsData).some(v => v > 0)) {
                new Chart(document.getElementById('conversionsChart'), {
                    type: 'line',
                    data: {
                        labels: Object.keys(conversionsData),
                        datasets: [{
                            label: 'Conversions',
                            data: Object.values(conversionsData),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: '#10b981',
                            pointHoverRadius: 7,
                            tension: 0.4
                        }]
                    },
                    options: globalOptions
                });
            } else {
                document.getElementById('conversionsChart').parentElement.innerHTML = '<p class="text-center text-gray-500 py-8">Aucune conversion enregistr√©e sur les 12 derniers mois</p>';
            }

            // === MODALIT√â ===
            new Chart(document.getElementById('modalityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['üíª En Ligne', 'üè´ Pr√©sentiel'],
                    datasets: [{
                        data: [{{ online_count }}, {{ in_person_count }}],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 12 },
                                padding: 15,
                                usePointStyle: true,
                                color: '#666'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 12, weight: 'bold' },
                            bodyFont: { size: 11 }
                        }
                    }
                }
            });

            // === COURS DEMAND√âS ===
            const coursesNames = Object.keys(coursesData).slice(0, 10);
            const coursesValues = Object.values(coursesData).slice(0, 10);
            
            new Chart(document.getElementById('coursesChart'), {
                type: 'bar',
                data: {
                    labels: coursesNames,
                    datasets: [{
                        label: 'Demandes',
                        data: coursesValues,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#666', font: { size: 11 } },
                            grid: { color: '#f0f0f0' }
                        },
                        y: {
                            ticks: { 
                                color: '#666', 
                                font: { size: 9 },
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 45) {
                                        return label.substr(0, 42) + '...';
                                    }
                                    return label;
                                }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });

            // === ACTIVIT√âS ===
            const activitiesNames = Object.keys(activitiesData).slice(0, 10);
            const activitiesValues = Object.values(activitiesData).slice(0, 10);
            
            new Chart(document.getElementById('activitiesChart'), {
                type: 'bar',
                data: {
                    labels: activitiesNames,
                    datasets: [{
                        label: 'Demandes',
                        data: activitiesValues,
                        backgroundColor: 'rgba(168, 85, 247, 0.7)',
                        borderColor: 'rgb(168, 85, 247)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#666', font: { size: 11 } },
                            grid: { color: '#f0f0f0' }
                        },
                        y: {
                            ticks: { 
                                color: '#666', 
                                font: { size: 10 },
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 40) {
                                        return label.substr(0, 37) + '...';
                                    }
                                    return label;
                                }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });

            // === SOURCES ===
            new Chart(document.getElementById('sourcesChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sourcesData),
                    datasets: [{
                        data: Object.values(sourcesData),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(14, 165, 233, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { size: 12 },
                                padding: 15,
                                usePointStyle: true,
                                color: '#666'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 12, weight: 'bold' },
                            bodyFont: { size: 11 }
                        }
                    }
                }
            });
        });
    </script>

{% endblock %}
